name: CI Pipeline

on:
  push:
    branches: [ "master", "develop" ]
  pull_request:
    branches: [ "master", "develop" ]

jobs:
  compile:
    name: Compile Project
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'

    - name: Generate OpenAPI classes
      run: mvn -B openapi-generator:generate

    - name: Compile project
      run: mvn -B compile

    - name: Upload compilation results
      uses: actions/upload-artifact@v4
      with:
        name: compilation-success
        path: target/classes/
        retention-days: 1

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: compile  # Solo ejecuta tests si la compilación fue exitosa
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'

    - name: Generate OpenAPI classes
      run: mvn -B openapi-generator:generate

    - name: Run all tests
      run: mvn -B test

    - name: Test Results
      if: always()
      run: |
        if [ $? -eq 0 ]; then
          echo "✅ All tests passed!"
        else
          echo "❌ Some tests failed"
          exit 1
        fi